<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  
  <link rel="shortcut icon" href="../../img/favicon.ico">
  <title>去中心化交易所 - 波场文档</title>
  <link href='https://fonts.googleapis.com/css?family=Lato:400,700|Roboto+Slab:400,700|Inconsolata:400,700' rel='stylesheet' type='text/css'>

  <link rel="stylesheet" href="../../css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../css/theme_extra.css" type="text/css" />
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/github.min.css">
  
  <script>
    // Current page data
    var mkdocs_page_name = "\u53bb\u4e2d\u5fc3\u5316\u4ea4\u6613\u6240";
    var mkdocs_page_input_path = "mechanism&algorithm/dex.md";
    var mkdocs_page_url = null;
  </script>
  
  <script src="../../js/jquery-2.1.1.min.js" defer></script>
  <script src="../../js/modernizr-2.8.3.min.js" defer></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script> 
  
</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side stickynav">
      <div class="wy-side-nav-search">
        <a href="../.." class="icon icon-home"> 波场文档</a>
        <div role="search">
  <form id ="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" title="Type search term here" />
  </form>
</div>
      </div>

      <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
	<ul class="current">
	  
          
            <li class="toctree-l1">
		
    <span class="caption-text">简介</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../introduction/">项目仓库</a>
                </li>
                <li class="">
                    
    <a class="" href="../../introduction/dpos/">波场共识</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">接口</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../api/http/">Http接口</a>
                </li>
                <li class="">
                    
    <a class="" href="../../api/rpc/">Rpc接口</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">机制与算法</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../sr/">超级代表与委员会</a>
                </li>
                <li class="">
                    
    <a class="" href="../trc10/">TRC-10</a>
                </li>
                <li class="">
                    
    <a class="" href="../account/">账户模型</a>
                </li>
                <li class="">
                    
    <a class="" href="../resource/">资源模型</a>
                </li>
                <li class=" current">
                    
    <a class="current" href="./">去中心化交易所</a>
    <ul class="subnav">
            
    <li class="toctree-l3"><a href="#_1">什么是交易对</a></li>
    

    <li class="toctree-l3"><a href="#_2">创建交易对</a></li>
    

    <li class="toctree-l3"><a href="#_3">交易</a></li>
    

    <li class="toctree-l3"><a href="#_4">注资</a></li>
    

    <li class="toctree-l3"><a href="#_5">撤资</a></li>
    

    <li class="toctree-l3"><a href="#_6">查询</a></li>
    

    </ul>
                </li>
                <li class="">
                    
    <a class="" href="../multi-signatures/">多重签名</a>
                </li>
                <li class="">
                    
    <a class="" href="../shielded-transaction/">匿名交易</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">架构</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../architecture/network/">网络</a>
                </li>
                <li class="">
                    
    <a class="" href="../../architecture/database/">数据库</a>
                </li>
                <li class="">
                    
    <a class="" href="../../architecture/plugin/">插件</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">合约</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../contracts/tvm/">虚拟机</a>
                </li>
                <li class="">
                    
    <a class="" href="../../contracts/compiler/">编译器</a>
                </li>
                <li class="">
                    
    <a class="" href="../../contracts/contract/">合约</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">开发者</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../developers/official-public-nodes/">官方节点</a>
                </li>
                <li class="">
                    
    <a class="" href="../../developers/deployment/">部署</a>
                </li>
                <li class="">
                    
    <a class="" href="../../developers/resources/">资源</a>
                </li>
                <li class="">
                    
    <a class="" href="../../developers/contribution/">参与开发</a>
                </li>
                <li class="">
                    
    <a class="" href="../../developers/incentives/">激励政策</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <span class="caption-text">客户端</span>
    <ul class="subnav">
                <li class="">
                    
    <a class="" href="../../clients/wallet-cli/">命令行钱包</a>
                </li>
    </ul>
	    </li>
          
            <li class="toctree-l1">
		
    <a class="" href="../../q&a/qa/">常见问题</a>
	    </li>
          
        </ul>
      </div>
      &nbsp;
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../..">波场文档</a>
      </nav>

      
      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../..">Docs</a> &raquo;</li>
    
      
        
          <li>机制与算法 &raquo;</li>
        
      
    
    <li>去中心化交易所</li>
    <li class="wy-breadcrumbs-aside">
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main">
            <div class="section">
              
                <h2 id="_1">什么是交易对</h2>
<p>TRON网络原生支持去中心化交易所(DEX)。去中心化交易所由多个交易对构成。一个交易对（Exchange）是token与token之间，或者token与TRX之间的交易市场（Exchange Market）。
任何账户都可以创建任何token之间的交易对，即使TRON网络中已经存在相同的交易对。交易对的买卖与价格波动遵循Bancor协议。
TRON网络规定，所有交易对中的两个token的权重相等，因此它们数量（balance）的比率即是它们之间的价格。
举一个简单的例子，假设一个交易对包含ABC和DEF两种token，ABC的balance为1000万，DEF的balance为100万，由于权重相等，因此10 ABC = 1 DEF，也就是说，当前ABC对于DEF的价格为10ABC/DEF。</p>
<h2 id="_2">创建交易对</h2>
<p>任何账户都可以创建任何token之间的交易对。创建交易对的手续费是1024TRX，这个手续费会被TRON网络烧掉。 <br />
创建交易对相当于为该交易对注入（inject）原始资本，因此创建者账户中要拥有该交易对的初始balance。当创建成功后，会立即从创建者账户中扣除这两个token的balance。</p>
<p>创建交易对的合约是ExchangeCreateContract，该合约有4个参数：
- first_token_id，第1种token的id <br />
- first_token_balance，第1种token的balance <br />
- second_token_id，第2种token的id <br />
- second_token_balance，第2种token的balance   </p>
<p>如果交易对中包含TRX，则使用" _ "表示TRX的id。需要注意的是，TRX的单位是SUN。  <br />
例子：  </p>
<pre><code class="text">ExchangeCreate abc 10000000 _ 1000000000000    
</code></pre>

<p>该交易会创建abc与TRX之间的交易对，初始balance分别为10000000个abc和1000000000000 sun（1000000TRX），
如果创建者没有足够的abc和TRX，则交易对创建失败；否则创建者账户中立即扣除相应的abc和TRX，交易对创建成功，可以开始交易。</p>
<h2 id="_3">交易</h2>
<p>任何账户都可以在任何交易对中进行交易。交易量和价格完全遵循Bancor协议。也就是说，一个账户在交易时，交易的对象是exchange。交易是即时的，不需要挂单和抢单，只要有足够的token，就可以交易成功。     </p>
<p>交易的合约是ExchangeTransactionContract，该合约有3个参数：   <br />
 - exchange_id，交易对的id，TRON网络会根据交易对创建时间顺序给每个交易对唯一的id
 - token_id，要卖出的token的id
 - quant，要卖出的token的金额
 - expected，期望得到的另一个token的最小金额。如果小于此数值，交易不会成功</p>
<p>例子：     <br />
我们在刚刚创建的abc与TRX的交易对中进行交易，假设此交易对id为1，当前交易对中abc balance为10000000，TRX balance为1000000，如果期望花100个TRX买到至少990个abc，则      </p>
<pre><code class="text">ExchangeTransaction 1 _ 100 990 
</code></pre>

<p>其中" _ "表示TRX，即向交易对卖出100个TRX。如果成功，该交易会使得交易对中增加100个TRX，并根据Bancor协议计算出减少的abc的数量，交易对创建者的账户中abc和TRX的数量会相应地增加和减少。  </p>
<h2 id="_4">注资</h2>
<p>当一个交易对其中1种token的balance很小时，只需要很小的交易量就会造成很大的价格波动，这不利于正常交易。为了避免这种情况，该交易对的创建者可以选择向该交易对注资（inject）。<br />
一个交易对只能由该交易对的创建者来注资。注资不需要手续费。  <br />
注资需要指定一种token以及注资金额，TRON网络会自动根据当前交易对中两种token的比例，计算出另一个token所需的金额，从而保证注资前后，交易对中两个token的比例相同，价格没有变化。   与创建交易对相同，注资要求创建者拥有足够多的两种token的balance。   </p>
<p>注资的合约是ExchangeInjectContract，该合约有3个参数： 
 - exchange_id，交易对的id
 - token_id，要注资的token的id
 - quant，要注资的token的金额</p>
<p>例子：  <br />
我们对刚刚创建的abc与TRX的交易对进行注资，假设此交易对id为1（TRON网络中第1个交易对），当前交易对中abc balance为10000000，TRX balance为1000000，如果要增加10%的abc，则</p>
<pre><code class="text">ExchangeInject 1 abc 1000000
</code></pre>

<p>如果成功，该交易会使得交易对中增加1000000个abc，并增加100000个TRX，交易对创建者的账户中abc和TRX的数量会相应地减少。</p>
<h2 id="_5">撤资</h2>
<p>一个交易对中的所有资产都是创建者的。创建者可以随时撤资（withdraw），把交易对中的token赎回到自身账户中。一个交易对只能由该交易对的创建者来撤资。撤资不需要手续费。    <br />
和注资一样，撤资需要指定一种token以及撤资金额，TRON网络会自动根据当前交易对中两种token的比例，计算出另一个token撤资的金额，从而保证撤资前后，交易对中两个token的比例相同，价格没有变化。    <br />
撤资前后价格没有变化，但是价格波动会更大。  </p>
<p>撤资的合约是ExchangeWithdrawContract，该合约有3个参数：  <br />
 - exchange_id，交易对的id
 - token_id，要撤资的token的id
 - quant，要撤资的token的金额</p>
<p>例子：  <br />
我们对之前创建的abc与TRX的交易对进行撤资，假设此交易对id为1，当前交易对中abc balance为10000000，TRX balance为1000000，如果要赎回10%的abc，则    </p>
<pre><code>ExchangeWithdraw 1 abc 1000000
</code></pre>

<p>如果成功，该交易会使得交易对中减少1000000个abc，以及减少100000个TRX，交易对创建者的账户中abc和TRX的数量会相应地增加。</p>
<h2 id="_6">查询</h2>
<p><h3> 1. 查询交易 </h3>
有三个查询交易对的接口，包括：<br />
查询所有交易对信息（ListExchanges）<br />
分页查询交易对信息（GetPaginatedExchangeList）(Odyssey-v3.1.1暂不支持)<br />
查询指定交易对信息（GetExchangeById）  </p>
<p>相关api详情，请查询<a href="https://github.com/tronprotocol/Documentation/blob/master/%E4%B8%AD%E6%96%87%E6%96%87%E6%A1%A3/%E6%B3%A2%E5%9C%BA%E5%8D%8F%E8%AE%AE/%E6%B3%A2%E5%9C%BA%E9%92%B1%E5%8C%85RPC-API.md#64-%E6%9F%A5%E8%AF%A2%E6%8C%87%E5%AE%9A%E4%BA%A4%E6%98%93%E5%AF%B9">波场RPC-API说明</a>  </p>
<h3> 2. 计算当前价格 </h3>

<p>交易中token的当前价格信息的计算过程：  </p>
<p>假设 first_token 当前的价格为 100 Sun，first_token_balance 为1000_000,second_token_balance 为2000_000，<br />
second_token 当前的价格为 first_token * first_token_balance/second_token_balance = 50 Sun <br />
first_token的价格可有"first_token&amp;&amp;TRX"交易对计算获得  </p>
<h3> 3. 计算交易获得token量 </h3>

<p>交易中花费first_token置换获得的second_token的数量的计算过程：</p>
<p>sellTokenQuant是要卖出的first_token的金额  <br />
buyTokenQuant是要买入的second_token的金额  <br />
supply = 1_000_000_000_000_000_000L
supplyQuant = -supply * (1.0 - Math.pow(1.0 + (double) sellTokenQuant/（firstTokenBalance + sellTokenQuant）, 0.0005))
buyTokenQuant = （long）balance * (Math.pow(1.0 + (double) supplyQuant / supply, 2000.0) - 1.0)</p>
<p>注意：由于网络其他账户发生交易，价格可能发生变化。    </p>
<p>相关api详情，请查询<a href="../../api/http/">http api</a>。</p>
              
            </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../multi-signatures/" class="btn btn-neutral float-right" title="多重签名">Next <span class="icon icon-circle-arrow-right"></span></a>
      
      
        <a href="../resource/" class="btn btn-neutral" title="资源模型"><span class="icon icon-circle-arrow-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <!-- Copyright etc -->
    
  </div>

  Built with <a href="http://www.mkdocs.org">MkDocs</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>.
</footer>
      
        </div>
      </div>

    </section>

  </div>

  <div class="rst-versions" role="note" style="cursor: pointer">
    <span class="rst-current-version" data-toggle="rst-current-version">
      
      
        <span><a href="../resource/" style="color: #fcfcfc;">&laquo; Previous</a></span>
      
      
        <span style="margin-left: 15px"><a href="../multi-signatures/" style="color: #fcfcfc">Next &raquo;</a></span>
      
    </span>
</div>
    <script>var base_url = '../..';</script>
    <script src="../../js/theme.js" defer></script>
      <script src="../../search/main.js" defer></script>

</body>
</html>
